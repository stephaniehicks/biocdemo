<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Large-scale clustering in Bioconductor • biocdemo</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Large-scale clustering in Bioconductor">
<meta property="og:description" content="biocdemo">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">biocdemo</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.99.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Demo.html">Large-scale clustering in Bioconductor</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/stephaniehicks/biocdemo">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Demo_files/header-attrs-2.5/header-attrs.js"></script><script src="Demo_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="Demo_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="Demo_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Large-scale clustering in Bioconductor</h1>
                        <h4 class="author">Davide Risso and Stephanie Hicks</h4>
            
            <h4 class="date">Last modified: November 18, 2020; Compiled: November 16, 2020</h4>
      
      
      <div class="hidden name"><code>Demo.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>In this demo, we will showcase an end-to-end clustering pipeline, starting from the count data matrix stored in HDF5 (similar to what one would download from the HCA data portal) all the way to visualization and interpretation of the clustering results.</p>
<p>While we use a small-ish dataset for this demo for convenience, the code is computationally efficient even for (very) large datasets.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">SingleCellExperiment</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">TENxPBMCData</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://bioconductor.org/packages/scater/">scater</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">scran</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/scry.html">scry</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mbkmeans</span><span class="op">)</span></code></pre></div>
</div>
<div id="getting-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-the-data" class="anchor"></a>Getting the data</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/TENxPBMCData/man/TENxPBMCData.html">TENxPBMCData</a></span><span class="op">(</span><span class="st">"pbmc4k"</span><span class="op">)</span>
<span class="va">sce</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 33694 4340 
## metadata(0):
## assays(1): counts
## rownames(33694): ENSG00000243485 ENSG00000237613 ... ENSG00000277475
##   ENSG00000268674
## rowData names(3): ENSEMBL_ID Symbol_TENx Symbol
## colnames: NULL
## colData names(11): Sample Barcode ... Individual Date_published
## reducedDimNames(0):
## altExpNames(0):</code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">counts</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span></code></pre></div>
<pre><code>## &lt;33694 x 4340&gt; matrix of class DelayedMatrix and type "integer":
##                    [,1]    [,2]    [,3]    [,4] ... [,4337] [,4338] [,4339]
## ENSG00000243485       0       0       0       0   .       0       0       0
## ENSG00000237613       0       0       0       0   .       0       0       0
## ENSG00000186092       0       0       0       0   .       0       0       0
## ENSG00000238009       0       0       0       0   .       0       0       0
## ENSG00000239945       0       0       0       0   .       0       0       0
##             ...       .       .       .       .   .       .       .       .
## ENSG00000277856       0       0       0       0   .       0       0       0
## ENSG00000275063       0       0       0       0   .       0       0       0
## ENSG00000271254       0       0       0       0   .       0       0       0
## ENSG00000277475       0       0       0       0   .       0       0       0
## ENSG00000268674       0       0       0       0   .       0       0       0
##                 [,4340]
## ENSG00000243485       0
## ENSG00000237613       0
## ENSG00000186092       0
## ENSG00000238009       0
## ENSG00000239945       0
##             ...       .
## ENSG00000277856       0
## ENSG00000275063       0
## ENSG00000271254       0
## ENSG00000277475       0
## ENSG00000268674       0</code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">seed</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">counts</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## An object of class "HDF5ArraySeed"
## Slot "filepath":
## [1] "/users/shicks1/.cache/ExperimentHub/76a2184a7c59_1611"
## 
## Slot "name":
## [1] "counts"
## 
## Slot "as_sparse":
## [1] FALSE
## 
## Slot "type":
## [1] NA
## 
## Slot "dim":
## [1] 33694  4340
## 
## Slot "chunkdim":
## [1] 512  66
## 
## Slot "first_val":
## [1] 0</code></pre>
<p>In this demo we use a small dataset for the sake of running all the code in a short amount of time. However, this workflow is designed for large data and it will run just fine with any sized dataset. For instance, we have analyzed 1.3 million cells on a machine with a moderately sized RAM (e.g., 64GB).</p>
<p>By running the code below, you will run the workflow on the 10X Genomics 1.3 million cells dataset. (Warning: it takes some time!) Alternatively, you can substitute the code below with your own data in <code>SingleCellExperiment</code> format.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">TENxBrainData</span><span class="op">)</span>
<span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/TENxBrainData/man/TENxBrainData.html">TENxBrainData</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">sce</span></code></pre></div>
</div>
<div id="filtering-and-normalization" class="section level2">
<h2 class="hasAnchor">
<a href="#filtering-and-normalization" class="anchor"></a>Filtering and normalization</h2>
<div id="removing-low-quality-cells" class="section level3">
<h3 class="hasAnchor">
<a href="#removing-low-quality-cells" class="anchor"></a>Removing low-quality cells</h3>
<p>First, we use the <code>scater</code> package to compute a set of QC measures and filter out the low-quality samples.</p>
<p>Here, we exclude those cells that have a too high percentage of mitochondrial genes or for which we detect too few genes.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scuttle/man/addPerCellQC.html">addPerCellQC</a></span><span class="op">(</span><span class="va">sce</span>, 
            subsets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Mito <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"^MT-"</span>, <span class="fu">rowData</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">Symbol_TENx</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">high_mito</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scuttle/man/isOutlier.html">isOutlier</a></span><span class="op">(</span><span class="va">sce</span><span class="op">$</span><span class="va">subsets_Mito_percent</span>, 
                       nmads <span class="op">=</span> <span class="fl">3</span>, type<span class="op">=</span><span class="st">"higher"</span><span class="op">)</span>
<span class="va">low_detection</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">sce</span><span class="op">$</span><span class="va">detected</span> <span class="op">&lt;</span> <span class="fl">1000</span><span class="op">)</span>
<span class="va">high_counts</span> <span class="op">&lt;-</span> <span class="va">sce</span><span class="op">$</span><span class="va">sum</span> <span class="op">&gt;</span> <span class="fl">45000</span>
<span class="va">sce</span> <span class="op">&lt;-</span> <span class="va">sce</span><span class="op">[</span>,<span class="op">!</span><span class="va">high_mito</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">low_detection</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">high_counts</span><span class="op">]</span>
<span class="va">sce</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 33694 3401 
## metadata(0):
## assays(1): counts
## rownames(33694): ENSG00000243485 ENSG00000237613 ... ENSG00000277475
##   ENSG00000268674
## rowData names(3): ENSEMBL_ID Symbol_TENx Symbol
## colnames: NULL
## colData names(17): Sample Barcode ... subsets_Mito_percent total
## reducedDimNames(0):
## altExpNames(0):</code></pre>
</div>
<div id="removing-lowly-expressed-genes" class="section level3">
<h3 class="hasAnchor">
<a href="#removing-lowly-expressed-genes" class="anchor"></a>Removing lowly expressed genes</h3>
<p>Next, we remove the lowly expressed genes. Here, we keep only those genes that have at least 1 UMI in at least 5% of the data. These threshold are dataset-specific and may need to be taylored to specific applications.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">num_reads</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">num_cells</span> <span class="op">&lt;-</span> <span class="fl">0.01</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span>
<span class="va">keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu">DelayedArray</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DelayedArray/man/DelayedMatrix-stats.html">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">counts</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">num_reads</span> <span class="op">)</span> <span class="op">&gt;=</span> <span class="va">num_cells</span><span class="op">)</span>
<span class="va">sce</span> <span class="op">&lt;-</span> <span class="va">sce</span><span class="op">[</span><span class="va">keep</span>,<span class="op">]</span>
<span class="va">sce</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 10944 3401 
## metadata(0):
## assays(1): counts
## rownames(10944): ENSG00000279457 ENSG00000228463 ... ENSG00000273748
##   ENSG00000278817
## rowData names(3): ENSEMBL_ID Symbol_TENx Symbol
## colnames: NULL
## colData names(17): Sample Barcode ... subsets_Mito_percent total
## reducedDimNames(0):
## altExpNames(0):</code></pre>
<p>These leaves us with <code><a href="https://rdrr.io/r/base/length.html">length(keep)</a></code> genes.</p>
</div>
<div id="normalization" class="section level3">
<h3 class="hasAnchor">
<a href="#normalization" class="anchor"></a>Normalization</h3>
<p>Here, we apply <code>mbkmeans</code> (<code>k=10</code> and batch size of 500) as a preliminary step to <code>scran</code> normalization.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">18</span><span class="op">)</span>
<span class="va">mbk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mbkmeans/man/mbkmeans.html">mbkmeans</a></span><span class="op">(</span><span class="va">sce</span>, whichAssay <span class="op">=</span> <span class="st">"counts"</span>, reduceMethod <span class="op">=</span> <span class="cn">NA</span>,
                  clusters<span class="op">=</span><span class="fl">10</span>, batch_size <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="va">sce</span><span class="op">$</span><span class="va">mbk10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"mbk"</span>, <span class="va">mbk</span><span class="op">$</span><span class="va">Clusters</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">mbk</span><span class="op">$</span><span class="va">Clusters</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##   1   2   3   4   5   6   7   8   9  10 
## 329 441 708   7 505 516  89 228  96 482</code></pre>
<p>We then compute the normalization factors and normalize the data.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scran/man/computeSumFactors.html">computeSumFactors</a></span><span class="op">(</span><span class="va">sce</span>, cluster<span class="op">=</span><span class="va">mbk</span><span class="op">$</span><span class="va">Clusters</span>, min.mean<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span>
<span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scuttle/man/logNormCounts.html">logNormCounts</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span>
<span class="va">sce</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 10944 3401 
## metadata(0):
## assays(2): counts logcounts
## rownames(10944): ENSG00000279457 ENSG00000228463 ... ENSG00000273748
##   ENSG00000278817
## rowData names(3): ENSEMBL_ID Symbol_TENx Symbol
## colnames: NULL
## colData names(19): Sample Barcode ... mbk10 sizeFactor
## reducedDimNames(0):
## altExpNames(0):</code></pre>
</div>
</div>
<div id="dimensionality-reduction" class="section level2">
<h2 class="hasAnchor">
<a href="#dimensionality-reduction" class="anchor"></a>Dimensionality reduction</h2>
<div id="pca-on-normalized-values" class="section level3">
<h3 class="hasAnchor">
<a href="#pca-on-normalized-values" class="anchor"></a>PCA on normalized values</h3>
<p>Here, we compute the first 50 principal components using the top variable genes.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scater/man/runPCA.html">runPCA</a></span><span class="op">(</span><span class="va">sce</span>, ncomponents <span class="op">=</span> <span class="fl">50</span>,
                      ntop <span class="op">=</span> <span class="fl">1000</span>,
                      scale <span class="op">=</span> <span class="cn">TRUE</span>,
                      BSPARAM <span class="op">=</span> <span class="fu">BiocSingular</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocSingular/man/BiocSingularParam.html">RandomParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/scater/man/plot_reddim.html">plotPCA</a></span><span class="op">(</span><span class="va">sce</span>, colour_by <span class="op">=</span> <span class="st">"mbk10"</span><span class="op">)</span></code></pre></div>
<p><img src="Demo_files/figure-html/pca-1.png" width="700"></p>
</div>
<div id="glm-pca" class="section level3">
<h3 class="hasAnchor">
<a href="#glm-pca" class="anchor"></a>GLM-PCA</h3>
<p>An alternative to PCA on normalized data is to use the GLM-PCA approach, implemented in the <code>scry</code> Bioconductor package. Here, we use the faster, approximate approach that computes the null residuals and runs PCA on them.</p>
<p>Other approaches implemented in Bioconductor for dimensionality reduction include correspondence analysis (in the <code>corral</code> package) and ZINB-WaVE (in the <code>zinbwave</code> and <code>NewWave</code> packages).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scry/man/nullResiduals.html">nullResiduals</a></span><span class="op">(</span><span class="va">sce</span>, assay<span class="op">=</span><span class="st">"counts"</span>, type<span class="op">=</span><span class="st">"deviance"</span><span class="op">)</span>
<span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scater/man/runPCA.html">runPCA</a></span><span class="op">(</span><span class="va">sce</span>, ncomponents <span class="op">=</span> <span class="fl">50</span>,
                      ntop <span class="op">=</span> <span class="fl">1000</span>,
                      exprs_values <span class="op">=</span> <span class="st">"binomial_deviance_residuals"</span>,
                      scale <span class="op">=</span> <span class="cn">TRUE</span>, name <span class="op">=</span> <span class="st">"GLM-PCA"</span>,
                      BSPARAM <span class="op">=</span> <span class="fu">BiocSingular</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocSingular/man/BiocSingularParam.html">RandomParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html">plotReducedDim</a></span><span class="op">(</span><span class="va">sce</span>, dimred <span class="op">=</span> <span class="st">"GLM-PCA"</span>, colour_by <span class="op">=</span> <span class="st">"mbk10"</span><span class="op">)</span></code></pre></div>
<p><img src="Demo_files/figure-html/glmpca-1.png" width="700"></p>
</div>
</div>
<div id="clustering" class="section level2">
<h2 class="hasAnchor">
<a href="#clustering" class="anchor"></a>Clustering</h2>
<p>Here, we use the GLM-PCA results to obtain the final cluster labels. We use two alternative approaches: Louvain and mini-batch <em>k</em>-means.</p>
<div id="louvain" class="section level3">
<h3 class="hasAnchor">
<a href="#louvain" class="anchor"></a>Louvain</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scran/man/buildSNNGraph.html">buildSNNGraph</a></span><span class="op">(</span><span class="va">sce</span>, k<span class="op">=</span><span class="fl">10</span>, use.dimred <span class="op">=</span> <span class="st">"GLM-PCA"</span><span class="op">)</span>
<span class="va">lou</span> <span class="op">&lt;-</span> <span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/cluster_louvain.html">cluster_louvain</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span>
<span class="va">sce</span><span class="op">$</span><span class="va">louvain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Louvain"</span>, <span class="va">lou</span><span class="op">$</span><span class="va">membership</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">sce</span><span class="op">$</span><span class="va">louvain</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Louvain1 Louvain2 Louvain3 Louvain4 Louvain5 Louvain6 
##     1081      438      876      665       37      304</code></pre>
<p>If you want more control on the resolution of the clustering, you can use the Louvain implementation available in the <code>resolution</code> package. Alternatively, the <code>leiden</code> package implements the Leiden algorithm.</p>
</div>
<div id="mini-batch-k-means" class="section level3">
<h3 class="hasAnchor">
<a href="#mini-batch-k-means" class="anchor"></a>Mini-batch k-means</h3>
<p>Mini-batch <span class="math inline">\(k\)</span>-means is a faster version of <span class="math inline">\(k\)</span>-means that uses only a random “mini-batch” of data at each iteration. The algorithm is fast enough to cluster the 1.3 million cell data in the space of the top 50 PC in under 30 seconds.</p>
<p>Here, we run it multiple times to select the value of <span class="math inline">\(k\)</span> with the elbow method.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">k_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">20</span><span class="op">)</span>
<span class="va">km_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">k_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/mbkmeans/man/mbkmeans.html">mbkmeans</a></span><span class="op">(</span><span class="va">sce</span>, clusters <span class="op">=</span> <span class="va">k</span>, 
             batch_size <span class="op">=</span> <span class="fl">500</span>,
             reduceMethod <span class="op">=</span> <span class="st">"GLM-PCA"</span>,
             calc_wcss <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="va">wcss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">km_res</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">WCSS_per_cluster</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">k_list</span>, <span class="va">wcss</span>, type <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span></code></pre></div>
<p><img src="Demo_files/figure-html/select_k-1.png" width="700"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span><span class="op">$</span><span class="va">kmeans</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"mbk"</span>, <span class="va">km_res</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">k_list</span><span class="op">==</span><span class="fl">13</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Clusters</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">sce</span><span class="op">$</span><span class="va">kmeans</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  mbk1 mbk10 mbk11 mbk12 mbk13  mbk2  mbk3  mbk4  mbk5  mbk6  mbk7  mbk8  mbk9 
##   393   430     1   467   114     2   233    68     4    99   953   362   275</code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">sce</span><span class="op">$</span><span class="va">kmeans</span>, <span class="va">sce</span><span class="op">$</span><span class="va">louvain</span><span class="op">)</span></code></pre></div>
<pre><code>##        
##         Louvain1 Louvain2 Louvain3 Louvain4 Louvain5 Louvain6
##   mbk1         1      391        1        0        0        0
##   mbk10        0        0      430        0        0        0
##   mbk11        0        0        1        0        0        0
##   mbk12       81        0        1      385        0        0
##   mbk13        0        0        0       32        0       82
##   mbk2         0        0        2        0        0        0
##   mbk3         0        0        0      233        0        0
##   mbk4         0       46        0        0       19        3
##   mbk5         0        0        0        0        0        4
##   mbk6         0        0       81        0       17        1
##   mbk7       951        0        0        2        0        0
##   mbk8         0        1      360        0        1        0
##   mbk9        48        0        0       13        0      214</code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html">plotReducedDim</a></span><span class="op">(</span><span class="va">sce</span>, dimred <span class="op">=</span> <span class="st">"GLM-PCA"</span>, colour_by <span class="op">=</span> <span class="st">"louvain"</span><span class="op">)</span></code></pre></div>
<p><img src="Demo_files/figure-html/minibatch-1.png" width="700"></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html">plotReducedDim</a></span><span class="op">(</span><span class="va">sce</span>, dimred <span class="op">=</span> <span class="st">"GLM-PCA"</span>, colour_by <span class="op">=</span> <span class="st">"kmeans"</span><span class="op">)</span></code></pre></div>
<p><img src="Demo_files/figure-html/minibatch-2.png" width="700"></p>
</div>
</div>
<div id="cluster-interpretation" class="section level2">
<h2 class="hasAnchor">
<a href="#cluster-interpretation" class="anchor"></a>Cluster interpretation</h2>
<p>To interpret the 13 clusters, we start by computing a list of markers.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="va">sce</span><span class="op">[</span>,<span class="op">!</span><span class="op">(</span><span class="va">sce</span><span class="op">$</span><span class="va">kmeans</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mbk11"</span>, <span class="st">"mbk2"</span>, <span class="st">"mbk5"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/colLabels.html">colLabels</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">sce</span><span class="op">$</span><span class="va">kmeans</span>
<span class="va">markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scran/man/findMarkers.html">findMarkers</a></span><span class="op">(</span><span class="va">sce</span>, pval.type<span class="op">=</span><span class="st">"all"</span>, direction<span class="op">=</span><span class="st">"up"</span><span class="op">)</span>

<span class="va">chosen</span> <span class="op">&lt;-</span> <span class="st">"mbk1"</span>
<span class="va">interesting</span> <span class="op">&lt;-</span> <span class="va">markers</span><span class="op">[[</span><span class="va">chosen</span><span class="op">]</span><span class="op">]</span>
<span class="va">interesting</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></code></pre></div>
<pre><code>## DataFrame with 10 rows and 3 columns
##                     p.value         FDR summary.logFC
##                   &lt;numeric&gt;   &lt;numeric&gt;     &lt;numeric&gt;
## ENSG00000077238 2.71752e-17 2.97406e-13      0.692130
## ENSG00000211898 3.74564e-14 2.04962e-10      1.225241
## ENSG00000042980 5.15536e-12 1.88068e-08      0.511909
## ENSG00000247982 1.76128e-11 4.81885e-08      0.682113
## ENSG00000121966 2.13669e-10 4.67679e-07      0.422467
## ENSG00000147535 5.04086e-09 9.19452e-06      0.506170
## ENSG00000026559 7.33826e-09 1.14729e-05      0.194973
## ENSG00000104894 1.45849e-08 1.99521e-05      0.754678
## ENSG00000012124 9.64702e-08 1.17308e-04      0.534463
## ENSG00000101017 2.53684e-07 2.77632e-04      0.352960</code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">top10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">interesting</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span><span class="op">)</span>
<span class="fu">rowData</span><span class="op">(</span><span class="va">sce</span><span class="op">[</span><span class="va">top10</span>,<span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## DataFrame with 10 rows and 3 columns
##                      ENSEMBL_ID Symbol_TENx      Symbol
##                     &lt;character&gt; &lt;character&gt; &lt;character&gt;
## ENSG00000077238 ENSG00000077238        IL4R        IL4R
## ENSG00000211898 ENSG00000211898        IGHD          NA
## ENSG00000042980 ENSG00000042980      ADAM28      ADAM28
## ENSG00000247982 ENSG00000247982   LINC00926   LINC00926
## ENSG00000121966 ENSG00000121966       CXCR4       CXCR4
## ENSG00000147535 ENSG00000147535       PLPP5       PLPP5
## ENSG00000026559 ENSG00000026559       KCNG1       KCNG1
## ENSG00000104894 ENSG00000104894        CD37        CD37
## ENSG00000012124 ENSG00000012124        CD22        CD22
## ENSG00000101017 ENSG00000101017        CD40        CD40</code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">pheatmap</span><span class="op">)</span>
<span class="va">means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">logcounts</a></span><span class="op">(</span><span class="va">sce</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">top10</span>,<span class="st">"ENSG00000177455"</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">tapply</span>, <span class="va">sce</span><span class="op">$</span><span class="va">kmeans</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">rowData</span><span class="op">(</span><span class="va">sce</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">top10</span>,<span class="st">"ENSG00000177455"</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">Symbol_TENx</span>
<span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html">pheatmap</a></span><span class="op">(</span><span class="va">means</span>, scale <span class="op">=</span> <span class="st">"row"</span><span class="op">)</span></code></pre></div>
<p><img src="Demo_files/figure-html/markers-1.png" width="700"></p>
<p>The presence of CD40, IL4R suggests that these are activated B-cells.</p>
<p>Similar analyses can be carried out for all clusters.</p>
</div>
<div id="session-info" class="section level2">
<h2 class="hasAnchor">
<a href="#session-info" class="anchor"></a>Session info</h2>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## R version 4.0.3 Patched (2020-10-27 r79384)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: CentOS Linux 7 (Core)
## 
## Matrix products: default
## BLAS:   /jhpce/shared/jhpce/core/conda/miniconda3-4.6.14/envs/svnR-4.0.x/R/4.0.x/lib64/R/lib/libRblas.so
## LAPACK: /jhpce/shared/jhpce/core/conda/miniconda3-4.6.14/envs/svnR-4.0.x/R/4.0.x/lib64/R/lib/libRlapack.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] parallel  stats4    stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] pheatmap_1.0.12             mbkmeans_1.6.1             
##  [3] scry_1.2.0                  scran_1.18.1               
##  [5] scater_1.18.3               ggplot2_3.3.2              
##  [7] TENxPBMCData_1.8.0          HDF5Array_1.18.0           
##  [9] rhdf5_2.34.0                DelayedArray_0.16.0        
## [11] Matrix_1.2-18               SingleCellExperiment_1.12.0
## [13] SummarizedExperiment_1.20.0 Biobase_2.50.0             
## [15] GenomicRanges_1.42.0        GenomeInfoDb_1.26.0        
## [17] IRanges_2.24.0              S4Vectors_0.28.0           
## [19] BiocGenerics_0.36.0         MatrixGenerics_1.2.0       
## [21] matrixStats_0.57.0         
## 
## loaded via a namespace (and not attached):
##   [1] ggbeeswarm_0.6.0              colorspace_2.0-0             
##   [3] ellipsis_0.3.1                rprojroot_2.0.2              
##   [5] benchmarkme_1.0.4             scuttle_1.0.0                
##   [7] bluster_1.0.0                 XVector_0.30.0               
##   [9] BiocNeighbors_1.8.1           fs_1.5.0                     
##  [11] farver_2.0.3                  bit64_4.0.5                  
##  [13] interactiveDisplayBase_1.28.0 AnnotationDbi_1.52.0         
##  [15] ClusterR_1.2.2                codetools_0.2-18             
##  [17] sparseMatrixStats_1.2.0       doParallel_1.0.16            
##  [19] knitr_1.30                    dbplyr_2.0.0                 
##  [21] shiny_1.5.0                   BiocManager_1.30.10          
##  [23] compiler_4.0.3                httr_1.4.2                   
##  [25] dqrng_0.2.1                   assertthat_0.2.1             
##  [27] fastmap_1.0.1                 limma_3.46.0                 
##  [29] later_1.1.0.1                 BiocSingular_1.6.0           
##  [31] htmltools_0.5.0               tools_4.0.3                  
##  [33] gmp_0.6-1                     rsvd_1.0.3                   
##  [35] igraph_1.2.6                  gtable_0.3.0                 
##  [37] glue_1.4.2                    GenomeInfoDbData_1.2.4       
##  [39] dplyr_1.0.2                   rappdirs_0.3.1               
##  [41] Rcpp_1.0.5                    pkgdown_1.6.1                
##  [43] vctrs_0.3.4                   rhdf5filters_1.2.0           
##  [45] ExperimentHub_1.16.0          iterators_1.0.13             
##  [47] DelayedMatrixStats_1.12.0     xfun_0.19                    
##  [49] stringr_1.4.0                 beachmat_2.6.1               
##  [51] mime_0.9                      lifecycle_0.2.0              
##  [53] irlba_2.3.3                   gtools_3.8.2                 
##  [55] statmod_1.4.35                AnnotationHub_2.22.0         
##  [57] edgeR_3.32.0                  zlibbioc_1.36.0              
##  [59] scales_1.1.1                  ragg_0.4.0                   
##  [61] promises_1.1.1                RColorBrewer_1.1-2           
##  [63] yaml_2.2.1                    curl_4.3                     
##  [65] memoise_1.1.0                 gridExtra_2.3                
##  [67] stringi_1.5.3                 RSQLite_2.2.1                
##  [69] BiocVersion_3.12.0            desc_1.2.0                   
##  [71] foreach_1.5.1                 BiocParallel_1.24.1          
##  [73] benchmarkmeData_1.0.4         rlang_0.4.8                  
##  [75] pkgconfig_2.0.3               systemfonts_0.3.2            
##  [77] bitops_1.0-6                  evaluate_0.14                
##  [79] lattice_0.20-41               purrr_0.3.4                  
##  [81] Rhdf5lib_1.12.0               labeling_0.4.2               
##  [83] bit_4.0.4                     tidyselect_1.1.0             
##  [85] magrittr_1.5                  R6_2.5.0                     
##  [87] generics_0.1.0                DBI_1.1.0                    
##  [89] pillar_1.4.6                  withr_2.3.0                  
##  [91] RCurl_1.98-1.2                tibble_3.0.4                 
##  [93] crayon_1.3.4                  BiocFileCache_1.14.0         
##  [95] rmarkdown_2.5                 viridis_0.5.1                
##  [97] locfit_1.5-9.4                grid_4.0.3                   
##  [99] blob_1.2.1                    digest_0.6.27                
## [101] xtable_1.8-4                  httpuv_1.5.4                 
## [103] textshaping_0.2.1             munsell_0.5.0                
## [105] beeswarm_0.2.3                viridisLite_0.3.0            
## [107] vipor_0.4.5</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Stephanie C. Hicks, Davide Risso.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
